# ROS2 xr-multi-agent-communication implementation 

*Note: Before going ahead and reading this README.md file, you should have read the README.md file in the root dir of this repository.*

## Abstract

The code stored in this dir of the repo represents the ROS side of the ROS2/Unity tandem project. It is essential to mention that the ROS code is written for ROS2 implementations.

This directory is home to 2 sub-directories, namely *docker* and *ros_packages.* In the *ros_packages* dir all the ROS2 code that is necessary for running the ROS side of the multi-agent-network (MAN) is stored. It further entails ROS packages for the demo applications (see details below on how to run the demo). The *docker* dir entails Dockerfiles and docker-compose files that allow a quick set-up for development and running the demo applications.

### docker

Dockerfiles and docker compose files for development, testing, and running the demos are stored in this dir. Simple docker build and docker compose commands allow you to run the code conainerized if you do not bother setting up a colcon workspace on your personal computer. Check out the section *How to run the code?* to see how the application can be run inside of docker containers.

### ROS2 packages

#### Multi-Agent-Network (MAN)

##### rosagent
This package must be run on any robot that is meant to connect to the multi-agent network. It enables the robot to connect to and communicate with the node on the MAN that is operating the rosrouter package. You can best think of this package as an interface between your ROS2 application and all other nodes on the multi-agent network.

On start-up, this package tries to connect to the rosrouter. If a connection can be established, the rosrouter sends configuration data back to this rosagent. The rosagent uses this data to set itself up for the data exchange between itself and the rosrouter. Specifically, the rosrouter sends the rosagent an ID that uniquely identifies this rosagent during its lifetime on the MAN.

##### rosrouter
The rosrouter package is only run once on the MAN and is uniquely identified by an IP address and a port number. It is possible to run the rosrouter locally (e.g. on a desktop computer or a docker container), on a robot or on a cloud platform. Therefore, maximum flexibility for any further development is provided.

This package is responsible for routing traffic between the different agents that are currently online on the MAN.

##### rosutility
rosutility entails functionality that is shared between the rosagent and rosrouter packages. In order to run the rosagent or rosrouter packages, this package must be built with them.

#### Demos
In order to obtain a better understanding of the working details of the ROS side of the MAN, demo packages are made available. Two of the packages, namely *unity_robotics_demo* and *unity_robotics_demo_msgs* are copies of demo packages from Unity's Unity-Robotics-Hub repository (https://github.com/Unity-Technologies/Unity-Robotics-Hub/tree/main). Unity's *ROS TCP Connector* uses these 2 packages for demo purposes, too.

##### demo
The demo package contains 4 ROS2 nodes to illustrate data exchange between different agents on the MAN. To illustrate subscriptions to a rosagent, image data generated by the rosagent can be sent to other agents on the MAN. To provide the rosagent with functionality to receive data from other MAN agents, a publisher node can be instantiated on the rosagent. Data sent to this publisher node is printed to the terminal by a subscriber node. 

- *webcam_publisher*: Uses the cv2 package to capture webcam data at a continuous rate and publishes it to a ROS2 topic. Hence, during the development of this project this node was tried to run on a variety of platforms; however, it only working on Linux/Ubuntu as other platforms, e.g. Macs and Windows machines, do not permit to access the webcam via commands of cv2.
- *image_publisher.py*: Publishes black images with a randomly colored diagonal stripe at a continuous rate. This node can be used instead of the webcam_publisher.py node, as it works platform independent.
- *image_subscriber.py*: Subscribes to the topic that the image_publisher node publishes to and shows the images in a separate window on the computer (this package is only intended to demonstrate that the image_publisher is working error free).
- *pose_subscriber*: Subscribes to pose messages that are sent to the rosagent which it is running on and prints its data in human-readable format to the terminal.

##### unity_robotics_demo (from Unity)
This package is a copy of the ROS2 package store on the Unity-Robotics-Hub under the same package name. It is leveraged by a rosagent to subscribe to color messages it receives from other MAN agents and send color messages to other MAN agents. Morevore, a ROS2 service node is implemented.

##### unity_robotics_demo_msgs (from Unity)
The unity_robotics_demo ROS2 package implements nodes that send ROS messages of types that are defined in this package. This package must thus be built alongside the unity_robotics_demo package (these two packages go hand-in-hand).

## How to run the code?

### How to run the code on your machine in a colcon workspace?
- Clone this repo onto your computer
- Create the ROS2 workspace: Create a new dir named *ros2_ws* in the *ros* dir (this is the ROS2 workspace dir and must have this name; other parts of the code require the workspace dir to be name *ros2_ws*)
- Create the ROS2 packages dir: Create a new dir name *src* in the newly created *ros2_ws* dir
- Copy all the relevant ROS2 packages from the dir *ros_packages* that is located inside the *ros* dir into the newly created *src* directory
  - For a rosagent, copy packages: rosagent and rosutility
  - For a rosrouter, copy packages: rosrouter and rosutility
  - The packages demo, unity_robotics_demo, and unity_robotics_demo_msgs only need to be copied, if you intend to run the demo applications
- Build the ROS2 packages: Navigate into the *ros2_ws* dir and run *colcon build*
- Install the packages: Run *source ./install/setup.bash* inside of the *ros2_ws* dir

##### Run the rosagent
```
ros2 run rosagent rosagent_node --ros-args -p router_ip_address:=<IP_ADDRESS> -p router_port:=<ROUTER_PORT> -p group_id:=<GROUP_ID>
```
Default ros-args are:
- router_ip_address = 127.0.0.1
- router_port = 7000
- group_id = 0 (id zero represents no group)

##### Run the rosrouter
```
ros2 run rosrouter rosrouter_node --ros-args -p ip_address:=<IP_ADDRESS> -p port:=<PORT>
```
Default ros-args are:
- ip_address = 127.0.0.1
- port = 7000

### How to run the code inside a provided docker container?
Execute all points from the above title *How to run the code on your machine in a colcon workspace?*, except the last one (build the ROS2 packages).

##### Building the docker images

- Navigate into the *ros* dir of this repository and run one or more of the following commands to build the docker images according to your needs:
  - docker dev image (runs the rosrouter and rosagent packages):
    ```
    docker build -t xr-ros:dev -f ./docker/dev/Dockerfile .
    ```
  - docker test or demo image (makes use of all ROS2 packages)
    ```
    docker build -t xr-ros:test -f ./docker/test/Dockerfile .
    ```
  - docker image to run the rosrouter
    ```
    docker build -t xr-ros:rosrouter -f ./docker/rosrouter/Dockerfile .
    ```

##### Running docker containers from docker-compose files

The docker-compose files are run from the directories in which they are stored. In order to run them, navigate into the dir of the docker-compose file you want to run and execute the following command (exchange FILE_NAME with the name of the file you want to execute):
```
docker compose -f docker-compose.<FILE_NAME>.yml up
```

### Running the demos (ROS2 side)

#### Demo running rosrouter locally

Navigate to *root/ros/docker/test/* and execute one of the following commands.
The created suite of docker containers from the docker test images includes one container running the rosrouter. This enables running the whole demo locally.

##### Single-agent demo
```
docker compose -f docker-compose.single-agent-test.yml up
```

##### Multi-agent demo
```
docker compose -f docker-compose.multi-agent-test.yml up
```

#### Demo running rosrouter remotely (e.g. on aws)

Navigate to *root/ros/docker/demo/* and execute one of the following commands.

##### Random image demo
```
docker compose -f docker-compose.random-image-demo.yml up
```

##### Webcam image demo (only possible on Linux)
```
docker compose -f docker-compose.webcam-demo.yml
```